---
title: "Phenology and Mycorrhizae Manuscript"
author: "Kathryn Wheeler"
date: "11/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load Functions and Variables
```{r}
source('sharedVariables.R')
source('NEON_Data_DownloadAndProcess.R')
```

Download NEON Data

#NEON Phenology Observations 
```{r,eval=FALSE}
source('combineNEONdata_PhenoObs.R')
dataName="NEON_PhenologyObservations"
NEON_ID='DP1.10055.001'

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
combineNEONdata_PhenoObs(saveType=="bySite") #Saved in individual files by site because 1 file was too large 
combineNEONdata_PhenoObs(saveType=="firstOfPhenophase")
combineNEONdata_PhenoObs(saveType = "allOfPhenophase")
```

#Single Air Temperature At Various Heights 
```{r,eval=FALSE}
dataName="NEON_SingleAirTemperature"
NEON_ID='DP1.00002.001'
selectColumns <- c('horizontalPosition','verticalPosition','tempSingleMean','tempSingleExpUncert','finalQF')
inFileName <- "SAAT_30min.csv"

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)

```

#Triple Air Temperature at Top of Canopy
```{r,eval=FALSE} 
##Need to redownload!! 
dataName="NEON_TemperatureData"
NEON_ID='DP1.00003.001'
selectColumns <- c('tempTripleMean','finalQF')
inFileName <- "TAAT_30min.csv"
varName <- 'tempTripleMean'

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)
calculateDailyWeather(dataName=dataName,dataPath=dataPath,varName=varName,funType=mean)
gapFillFromDaymet(dataName=dataName,dataPath=dataPath,varName=varName)

```

#Precipitation
```{r,eval=FALSE}
dataName="NEON_PrecipitationData"
NEON_ID='DP1.00006.001'
selectColumns <- c('precipBulk','precipExpUncert','precipQF')
inFileName <- c("PRIPRE_30min.csv","SECPRE_30min.csv")
varName <- "precipBulk"

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)
calculateDailyWeather(dataName=dataName,dataPath=dataPath,varName=varName,funType=sum)
gapFillFromDaymet(dataName=dataName,dataPath=dataPath,varName=varName)

```

#Download Photosynthetically active radiation (PAR)
```{r}
dataName="NEON_PAR"
NEON_ID='DP1.00024.001'
if(!file.exists(paste0(dataPath,"/",dataName))){
  dir.create(paste0(dataPath,"/",dataName))
}
selectColumns <- c('verticalPosition','PARMean','PARMinimum','PARMaximum','PARVariance','PARFinalQF')
inFileName <- "PARPAR_30min.csv"
# varName <- "precipBulk"

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)
calculateDailyWeather(dataName=dataName,dataPath=dataPath,varName=varName,funType=sum)


```


#Download NEON Soil Microbe Data
```{r,eval=FALSE}
dataName="NEON_SoilMicrobeComposition"
NEON_ID='DP1.10081.001'
#selectColumns <-
inFileName <- c("mcc_soilSeqVariantMetadata_16S.csv","mcc_soilSeqVariantMetadata_ITS.csv")
#varName <- 

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID) #Note: I had to modify this function to remove the indices for sites that didn't seem to have data. 
combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)
```

#Download NEON Soil Physical and Chemical Properties (Need to finish combining)
```{r,eval=FALSE}
dataName <- "NEON_soilProperties"
NEON_ID <- "DP1.10086.001"
if(!file.exists(paste0(dataPath,"/",dataName))){
  dir.create(paste0(dataPath,"/",dataName))
}

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID)
#inFileNames <- c(,"sls_soilMoisture","sls_soilpH")
inFileName <- "sls_soilCoreCollection.csv"
selectColumns <- c('plotID','decimalLatitude','decimalLongitude','elevation','standingWaterDepth','horizon',
                   'soilTemp','litterDepth','sampleTopDepth','sampleBottomDepth')
dat1 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)

inFileName <- "sls_soilpH.csv"
selectColumns <- c('plotID','horizon','soilInWaterpH','soilInCaClpH','pHSoilInWaterMass','pHWaterVol',
                   'waterpHRatio','pHSoilInCaClMass','pHCaClVol','caclpHRatio')
dat2 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)
allDat <- full_join(dat1,dat2,by=c('siteID','collectDate','plotID','horizon'))

inFileName <- "sls_soilMoisture.csv"
selectColumns <- c('plotID','horizon','boatMass','freshMassBoatMass','dryMassBoatMass','soilMoisture','dryMassFraction')
dat3 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)
allDat <- full_join(allDat,dat3,by=c('siteID','collectDate','plotID','horizon'))

outFileName <- paste0(dataName,"ALLdata.csv")
write.csv(file=paste0(dataPath,outFileName),allDat,row.names = FALSE,quote=FALSE)

```


#Download Soil Temp
```{r}
dataName="NEON_SoilTemp"
NEON_ID='DP1.00041.001'
if(!file.exists(paste0(dataPath,"/",dataName))){
  dir.create(paste0(dataPath,"/",dataName))
}

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID,andStack=FALSE) #missing 30 

selectColumns <- c('horizontalPosition','verticalPosition','soilTempMean','soilTempMinimum','soilTempMaximum','finalQF')
inFileName <- "ST_30_minute.csv"

combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,selectColumns=selectColumns,
                inFileName=inFileName,dataPath=dataPath)

```

#NEON Root Characteristics
```{r, eval=FALSE}
dataName="NEON_Roots"
NEON_ID='DP1.10067.001'

if(!file.exists(paste0(dataPath,"/",dataName))){
  dir.create(paste0(dataPath,"/",dataName))
}

downloadNEONdata(dataName=dataName,NEON_ID=NEON_ID) #missing 30 

inFileName <- 'bbc_dilution.csv'
selectColumns <- c('plotID','sampleVolume',
                   'dryMass','somDryMass')

dat1 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,
                       selectColumns=selectColumns, inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)
dat1 <- dat1 %>% mutate(density=dryMass/sampleVolume,
                        somDensity=somDryMass/sampleVolume) %>%
  dplyr::select(-c(sampleVolume,dryMass,somDryMass)) %>%
  group_by(siteID,collectDate,plotID) %>% summarise(densityMean=mean(density),somDensityMean=mean(somDensity))


inFileName <- 'bbc_percore.csv'
selectColumns <- c('plotID','decimalLatitude','decimalLongitude',
                   'litterDepth')

dat2 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,
                       selectColumns=selectColumns, inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)

dat2 <- dat2 %>% group_by(siteID,collectDate,plotID) %>%
  summarise(litterDepth=mean(litterDepth))

allDat <- full_join(dat1,dat2,by=c('siteID','collectDate','plotID'))

inFileName <- 'bbc_rootChemistry.csv'
selectColumns <- c('plotID','plotType',
                   'd15N','d13C','nitrogenPercent','carbonPercent',
                   'CNratio','cnIsotopeQF','cnPercentQF')

dat3 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,
                       selectColumns=selectColumns, inFileName=inFileName,dataPath=dataPath,saveFile = FALSE) 

dat3 <- dat3 %>% mutate(collectDate=format(as.POSIXct(collectDate,                                                  format='%Y-%m-%dT%H:%M'),format="%Y-%m-%d")) %>%
  filter(cnIsotopeQF=="OK",cnPercentQF=="OK") %>%
  group_by(siteID,collectDate,plotID) %>% summarise(d15N=mean(d15N),
                                                    d13C=mean(d13C),
                                                    nitrogenPercent=
                                                      mean(nitrogenPercent),
                                                    carbonPercent=
                                                      mean(carbonPercent),
                                                    CNratio=
                                                      mean(CNratio))
  
allDat <- full_join(allDat,dat3,by=c('siteID','collectDate','plotID'))

inFileName <- "bbc_rootmass.csv"
selectColumns <- c('plotID','dryMass','mycorrhizaeVisible') 

dat4 <- combineNEONdata(dataName=dataName,NEON_ID=NEON_ID,
                       selectColumns=selectColumns, inFileName=inFileName,dataPath=dataPath,saveFile = FALSE)
names(dat4)[names(dat4)=="dryMass"] <- "rootDryMass"
dat4$mycorrhizaeVisible[dat4$mycorrhizaeVisible=="N"] <- 0
dat4$mycorrhizaeVisible[dat4$mycorrhizaeVisible=="Y"] <- 1
dat4$mycorrhizaeVisible[dat4$mycorrhizaeVisible==""] <- NA

dat4 <- dat4 %>% group_by(siteID,collectDate,plotID) %>%
  summarise(rootDryMass=mean(rootDryMass),
            mycorrhizaeVisiblePercent=mean(as.numeric(mycorrhizaeVisible),na.rm=TRUE))


allDat <- full_join(allDat,dat4,by=c('siteID','collectDate','plotID'))
outFileName <- paste0(dataName,"ALLdata.csv")
write.csv(file=paste0(dataPath,outFileName),allDat,row.names = FALSE,quote=FALSE)
```

#NEON Plant Structural Characteristics
```{r}

```

#NEON Litterfall
```{r}

```

#NEON Foliar Traits
```{r}

```


#NEON PhenoCam Observations
```{r,eval=FALSE}
source('determinePhenoCamURLs.R')
source('downloadPhenoCamAndCalculateTransitions.R') #Still need to change to have it save it somewhere

```

